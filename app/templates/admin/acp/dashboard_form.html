{% extends "admin/base.html" %}
{% block page_title %}{% if item %}Edit Dashboard{% else %}New Dashboard{% endif %}{% endblock %}

{% block content %}
{% set item = item if item else None %}
<div class="card mb-3">
  <div class="card-header"><strong>{% if item %}Edit{% else %}Create{% endif %} Dashboard Document</strong></div>
  <div class="card-body">
    <form method="POST" class="row g-3">
      {{ csrf_input() }}
      <div class="col-md-5">
        <label class="form-label">Title</label>
        <input class="form-control" name="title" value="{{ item.title if item else '' }}" required>
      </div>
      <div class="col-md-4">
        <label class="form-label">Dashboard ID</label>
        <input class="form-control" name="dashboard_id" value="{{ item.dashboard_id if item else '' }}" required>
      </div>
      <div class="col-md-3">
        <label class="form-label">Layout Type</label>
        <select class="form-select" name="layout_type">
          {% set layout_type = item.layout_type if item else 'grid' %}
          <option value="grid" {% if layout_type == 'grid' %}selected{% endif %}>Grid</option>
          <option value="tree" {% if layout_type == 'tree' %}selected{% endif %}>Tree</option>
        </select>
      </div>
      <div class="col-md-5">
        <label class="form-label">Route</label>
        <input class="form-control" name="route" value="{{ item.route if item else '/dashboard/operations' }}" required>
      </div>
      <div class="col-md-3">
        <label class="form-label">Workflow Status</label>
        <select class="form-select" name="workflow_status">
          {% set selected_status = item.status if item else 'draft' %}
          {% for status in workflow_options %}
          <option value="{{ status }}" {% if selected_status == status %}selected{% endif %}>{{ workflow_status_label(status) }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label">Schedule</label>
        <input class="form-control" type="datetime-local" name="scheduled_publish_at" value="{{ format_datetime_local(item.scheduled_publish_at) if item else '' }}">
      </div>

      <div class="col-12">
        <label class="form-label">Layout Config JSON</label>
        <textarea class="form-control form-control-mono-sm" name="layout_config_json" rows="6">{{ item.layout_config_json if item else '{\n  "columns": 12,\n  "rowHeight": 72,\n  "gap": 12\n}' }}</textarea>
      </div>
      <div class="col-12">
        <label class="form-label">Widgets JSON</label>
        <textarea class="form-control form-control-mono-sm" name="widgets_json" rows="9">{{ item.widgets_json if item else '[\n  {\n    "type": "kpi-card",\n    "metric": "support_open_tickets",\n    "title": "Open Tickets",\n    "position": {"x": 0, "y": 0, "w": 3, "h": 2}\n  },\n  {\n    "type": "line-chart",\n    "metric": "tickets_7d",\n    "title": "7-Day Ticket Trend",\n    "position": {"x": 3, "y": 0, "w": 6, "h": 3}\n  },\n  {\n    "type": "table",\n    "metric": "latest_support_tickets",\n    "title": "Latest Tickets",\n    "position": {"x": 0, "y": 3, "w": 9, "h": 4}\n  }\n]' }}</textarea>
      </div>
      <div class="col-md-6">
        <label class="form-label">Global Filters JSON</label>
        <textarea class="form-control form-control-mono-sm" name="global_filters_json" rows="5">{{ item.global_filters_json if item else '[{"id": "dateRange", "type": "date_range"}, {"id": "priority", "type": "enum"}]' }}</textarea>
      </div>
      <div class="col-md-6">
        <label class="form-label">Role Visibility Rules JSON</label>
        <textarea class="form-control form-control-mono-sm" name="role_visibility_json" rows="5">{{ item.role_visibility_json if item else '{"admin": {"showAll": true}, "support": {"hiddenWidgets": ["financial-kpi"]}}' }}</textarea>
      </div>
      <div class="col-12">
        <label class="form-label">Change Note</label>
        <input class="form-control" name="change_note" placeholder="What changed in this version?">
      </div>
      <div class="col-12 d-flex gap-2 flex-wrap">
        <button class="btn btn-primary" type="submit"><i class="fa-solid fa-floppy-disk me-1"></i>Save</button>
        <a href="{{ url_for('admin.acp_dashboards') }}" class="btn btn-outline-secondary">Back to List</a>
        {% if item %}
        <a href="{{ url_for('main.acp_delivery_dashboard', dashboard_id=item.dashboard_id) }}" target="_blank" rel="noopener" class="btn btn-outline-primary">Open Delivery API</a>
        {% endif %}
      </div>
    </form>
  </div>
</div>

{% if item %}
<div class="row g-3">
  <div class="col-lg-4">
    <div class="card">
      <div class="card-header"><strong>Workflow Actions</strong></div>
      <div class="card-body">
        <form method="POST" action="{{ url_for('admin.acp_dashboard_publish', id=item.id) }}" class="vstack gap-2">
          {{ csrf_input() }}
          <label class="form-label">Set Status</label>
          <select class="form-select" name="workflow_status">
            {% for status in workflow_options %}
            <option value="{{ status }}">{{ workflow_status_label(status) }}</option>
            {% endfor %}
          </select>
          <label class="form-label">Scheduled Publish (optional)</label>
          <input class="form-control" type="datetime-local" name="scheduled_publish_at" value="{{ format_datetime_local(item.scheduled_publish_at) }}">
          <input class="form-control" name="change_note" placeholder="Publishing note">
          <button class="btn btn-outline-primary" type="submit">Apply Workflow</button>
        </form>
      </div>
    </div>
  </div>
  <div class="col-lg-8">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <strong>Version History</strong>
        <form method="POST" action="{{ url_for('admin.acp_dashboard_snapshot', id=item.id) }}" class="d-flex gap-2 align-items-center">
          {{ csrf_input() }}
          <input class="form-control form-control-sm" name="change_note" placeholder="Snapshot note">
          <button class="btn btn-sm btn-outline-primary" type="submit">Create Snapshot</button>
        </form>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover mb-0">
            <thead>
              <tr>
                <th>Version</th>
                <th>Note</th>
                <th>Created</th>
                <th>User</th>
              </tr>
            </thead>
            <tbody>
              {% for version in versions or [] %}
              <tr>
                <td>#{{ version.version_number }}</td>
                <td>{{ version.change_note or '—' }}</td>
                <td>{{ version.created_at.strftime('%Y-%m-%d %H:%M') if version.created_at else '—' }}</td>
                <td>{{ version.created_by_id or 'system' }}</td>
              </tr>
              {% else %}
              <tr><td colspan="4" class="text-muted">No versions yet.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
{% endif %}
{% endblock %}
